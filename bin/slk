#!/usr/bin/env node

'use strict';

var _ = require('lodash'),
  program = require('commander'),
  api = require('../lib/api'),
  colors = require('colors');

process.title = 'slk';

var listen = function(channel, oldest) {
  oldest = isNaN(parseFloat(oldest)) ? undefined : parseFloat(oldest);
  return api.channelsHistory(program.token, channel, oldest, function(e, results) {
    if (e) {
      console.error(e);
      process.exit(1);
    }
    var sorted = _.sortBy(results.messages, function(m) {
      return parseFloat(m.ts);
    });

    var latest = oldest;
    _.each(sorted, function(m) {
      latest = parseFloat(m.ts);
      console.log((m.username || m.user).green, m.text, ('(' + m.ts + ')').grey);
    });

    return setTimeout(function() {
      return listen(channel, latest);
    }, 30000);
  });
};

program
  .option('-t, --token <token>', 'set the authentication token')

program 
  .command('listen <channel>')
  .description('listen to a channel')
  .action(listen);

program.parse(process.argv);
