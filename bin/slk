#!/usr/bin/env node

'use strict';

var _ = require('lodash'),
    colors = require('colors'),
  request = require('request');

process.title = 'slk';

var argv = require('minimist')(process.argv.slice(2));

if (!argv.token) {
  console.log('missing --token');
  return process.exit(1);
}

var api = function(method, token, details, done) {
  var query = _.reduce(_.keys(details), function(accum, key) {
    return accum + '&' + key + '=' + details[key];
  }, '');

  var url = 'https://slack.com/api/' + method + '?token=' + token + query;
  return request(url, function(e, r, b) {
    if (e) {
      return done(e);
    }

    return done(null, JSON.parse(b));
  });
}

var channelsHistory = function(token, channel, oldest) {
  var details = {
    channel: channel
  }
  if (oldest) {
    details.oldest = oldest;
  }

  return api('channels.history', token, details, function(e, results) {
    if (e) {
      console.error(e);
      process.exit(1);
    }
    var sorted = _.sortBy(results.messages, function(m) {
      return parseFloat(m.ts);
    });
  
    var latest = oldest; 
    _.each(sorted, function(m) {
      latest = parseFloat(m.ts);
      console.log((m.username || m.user).green, m.text, ('(' + m.ts + ')').grey);
    });

    return setTimeout(function() {
      return channelsHistory(token, channel, latest);
    }, 30000);
  });
};

if (argv._[0] === 'follow' && argv.channel) {
  return channelsHistory(argv.token, argv.channel);
}

return process.exit(0);
